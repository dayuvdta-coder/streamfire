<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Streamingku</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f0f9ff;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
            border-left: 2px solid #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #000;
            border: 2px solid #fff;
        }
    </style>
</head>

<body class="text-black antialiased selection:bg-cyan-400 selection:text-black">

    <%- include('partials/header', { path: '/gallery' }) %>

        <div class="md:ml-64 min-h-screen flex flex-col">

            <header
                class="h-16 border-b-2 border-black bg-pink-400 sticky top-0 z-30 flex items-center px-4 md:px-8 shadow-sm">
                <h1
                    class="text-xl font-black text-black italic bg-white border-2 border-black px-3 py-1 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] uppercase">
                    <%= t.media_gallery %>
                </h1>
            </header>

            <main class="flex-1 p-4 md:p-8">

                <% if (!videos || videos.length===0) { %>
                    <div
                        class="flex flex-col items-center justify-center h-96 text-center border-4 border-black border-dashed bg-white">
                        <div
                            class="w-20 h-20 bg-yellow-400 border-2 border-black flex items-center justify-center mb-4 text-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                            <i class="fas fa-images text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-black text-black uppercase">
                            <%= t.no_videos_found %>
                        </h3>
                        <p
                            class="text-black font-bold text-sm mt-1 bg-cyan-200 inline-block px-2 border-2 border-black">
                            <%= t.uploaded_videos_appear_here %>
                        </p>
                    </div>
                    <% } else { %>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <% videos.forEach(video=> { %>
                                <% if (video.filename) { %>
                                    <div
                                        class="bg-white border-2 border-black shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] group cursor-pointer relative hover:translate-x-[3px] hover:translate-y-[3px] hover:shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] transition-all">
                                        <div class="aspect-video relative border-b-2 border-black">
                                            <video
                                                class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-300"
                                                preload="metadata">
                                                <% if (video.filename) { %>
                                                    <source src="/uploads/<%= video.filename %>#t=1.0" type="video/mp4">
                                                    <% } %>
                                            </video>
                                            <div
                                                class="absolute bottom-2 right-2 bg-black text-white border border-white px-1.5 py-0.5 text-[10px] font-bold">
                                                MP4
                                            </div>
                                        </div>
                                        <div class="p-3 bg-white">
                                            <h4 class="text-sm font-black text-black truncate uppercase"
                                                title="<%= video.title %>">
                                                <%= video.title %>
                                            </h4>
                                            <div
                                                class="text-[10px] text-gray-800 font-bold mt-2 flex items-center justify-between">
                                                <span class="bg-gray-200 px-1 border border-black">
                                                    <%= new Date().toLocaleDateString() %>
                                                </span>
                                                <div class="flex gap-2">
                                                    <button onclick="playVideo('/uploads/<%= video.filename %>')"
                                                        class="text-pink-600 hover:text-pink-800"><i
                                                            class="fas fa-play-circle mr-1"></i>
                                                        <%= t.preview %>
                                                    </button>
                                                    <button
                                                        data-video-id="<%= video.id %>"
                                                        data-video-title="<%= video.title || '' %>"
                                                        data-video-src="/uploads/<%= video.filename %>"
                                                        onclick="openEditModal(this)"
                                                        class="text-cyan-700 hover:text-cyan-900">
                                                        <i class="fas fa-pen-to-square"></i>
                                                    </button>
                                                    <button onclick="deleteVideo('<%= video.id %>')"
                                                        class="text-red-500 hover:text-red-700">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>
                                        <% }) %>
                        </div>
                        <% } %>

            </main>
        </div>

        <div id="videoModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4">
            <div
                class="bg-black border-2 border-white w-full max-w-4xl relative shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                <button onclick="closeVideoModal()"
                    class="absolute -top-10 right-0 text-white text-xl hover:text-red-500 font-bold uppercase tracking-widest">CLOSE
                    [X]</button>
                <video id="modalVideo" controls class="w-full h-auto aspect-video"></video>
            </div>
        </div>

        <div id="editModal"
            class="fixed inset-0 bg-black/80 z-[75] hidden items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white border-4 border-black w-full max-w-2xl shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                <div class="flex items-center justify-between px-4 py-3 border-b-2 border-black bg-cyan-300">
                    <h3 class="text-lg font-black uppercase">Edit Video (Watermark)</h3>
                    <button onclick="closeEditModal()"
                        class="w-8 h-8 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4">
                    <video id="editPreviewVideo" controls class="w-full aspect-video bg-black border-2 border-black"></video>

                    <input type="hidden" id="editVideoId">

                    <div>
                        <label for="editOutputTitle" class="block text-xs font-black uppercase mb-1">Judul Hasil Video</label>
                        <input id="editOutputTitle" type="text"
                            class="w-full border-2 border-black px-3 py-2 text-sm font-bold bg-gray-50 focus:bg-yellow-100 outline-none"
                            placeholder="Contoh: Produk A - Watermark">
                    </div>

                    <div>
                        <label for="editWatermarkText" class="block text-xs font-black uppercase mb-1">Teks Watermark</label>
                        <input id="editWatermarkText" type="text"
                            class="w-full border-2 border-black px-3 py-2 text-sm font-bold bg-gray-50 focus:bg-yellow-100 outline-none"
                            maxlength="100" placeholder="Contoh: @streamingku">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label for="editWatermarkPosition" class="block text-xs font-black uppercase mb-1">Posisi</label>
                            <select id="editWatermarkPosition"
                                class="w-full border-2 border-black px-3 py-2 text-sm font-bold bg-gray-50 focus:bg-yellow-100 outline-none">
                                <option value="top-left">Top Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="bottom-right" selected>Bottom Right</option>
                                <option value="center">Center</option>
                            </select>
                        </div>
                        <div>
                            <label for="editWatermarkSize" class="block text-xs font-black uppercase mb-1">Ukuran Font</label>
                            <input id="editWatermarkSize" type="number" min="16" max="96" value="30"
                                class="w-full border-2 border-black px-3 py-2 text-sm font-bold bg-gray-50 focus:bg-yellow-100 outline-none">
                        </div>
                        <div>
                            <label for="editWatermarkOpacity" class="block text-xs font-black uppercase mb-1">Opacity</label>
                            <input id="editWatermarkOpacity" type="number" min="0.15" max="1" step="0.05" value="0.85"
                                class="w-full border-2 border-black px-3 py-2 text-sm font-bold bg-gray-50 focus:bg-yellow-100 outline-none">
                        </div>
                    </div>
                </div>
                <div class="px-4 py-3 border-t-2 border-black flex flex-col sm:flex-row gap-2">
                    <button id="editApplyBtn" onclick="applyWatermarkEdit()"
                        class="flex-1 bg-black text-white border-2 border-black font-black py-2 uppercase hover:bg-gray-800 transition-colors">
                        Buat Video Watermark
                    </button>
                    <button onclick="closeEditModal()"
                        class="sm:w-40 bg-white border-2 border-black font-black py-2 uppercase hover:bg-gray-100 transition-colors">
                        Batal
                    </button>
                </div>
            </div>
        </div>

        <script>
            const editModal = document.getElementById('editModal');
            const editVideoId = document.getElementById('editVideoId');
            const editPreviewVideo = document.getElementById('editPreviewVideo');
            const editOutputTitle = document.getElementById('editOutputTitle');
            const editWatermarkText = document.getElementById('editWatermarkText');
            const editWatermarkPosition = document.getElementById('editWatermarkPosition');
            const editWatermarkSize = document.getElementById('editWatermarkSize');
            const editWatermarkOpacity = document.getElementById('editWatermarkOpacity');
            const editApplyBtn = document.getElementById('editApplyBtn');

            async function showAlert(icon, title, text) {
                if (window.Swal) {
                    return Swal.fire({
                        icon,
                        title,
                        text,
                        background: '#1f2937',
                        color: '#fff'
                    });
                }
                alert(title + '\n' + (text || ''));
                return Promise.resolve({ isConfirmed: true });
            }

            async function askConfirm(title, text) {
                if (window.Swal) {
                    return Swal.fire({
                        title,
                        text,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#ef4444',
                        cancelButtonColor: '#374151',
                        confirmButtonText: 'Lanjutkan',
                        background: '#1f2937',
                        color: '#fff'
                    });
                }
                return Promise.resolve({ isConfirmed: confirm((title || '') + '\n' + (text || '')) });
            }

            function playVideo(src) {
                const modal = document.getElementById('videoModal');
                const video = document.getElementById('modalVideo');
                video.src = src;
                modal.classList.remove('hidden');
                video.play();
            }

            function closeVideoModal() {
                const modal = document.getElementById('videoModal');
                const video = document.getElementById('modalVideo');
                video.pause();
                video.src = '';
                modal.classList.add('hidden');
            }

            function openEditModal(button) {
                if (!button || !editModal) return;
                const videoId = String(button.dataset.videoId || '').trim();
                const videoSrc = String(button.dataset.videoSrc || '').trim();
                const videoTitle = String(button.dataset.videoTitle || '').trim();

                if (!videoId || !videoSrc) return;

                editVideoId.value = videoId;
                editPreviewVideo.src = videoSrc;
                editOutputTitle.value = (videoTitle || 'Video') + ' (Watermark)';
                if (!editWatermarkText.value.trim()) {
                    editWatermarkText.value = '@streamingku';
                }
                editWatermarkPosition.value = 'bottom-right';
                editWatermarkSize.value = '30';
                editWatermarkOpacity.value = '0.85';

                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            }

            function closeEditModal() {
                if (!editModal) return;
                if (editPreviewVideo) {
                    editPreviewVideo.pause();
                    editPreviewVideo.removeAttribute('src');
                    editPreviewVideo.load();
                }
                editModal.classList.remove('flex');
                editModal.classList.add('hidden');
            }

            function sleep(ms) {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }

            async function waitWatermarkJob(jobId) {
                const timeoutAt = Date.now() + (30 * 60 * 1000);
                while (Date.now() < timeoutAt) {
                    await sleep(2000);
                    let resp;
                    try {
                        resp = await fetch('/api/video/watermark-job/' + encodeURIComponent(jobId), { cache: 'no-store' });
                    } catch (err) {
                        continue;
                    }

                    const data = await resp.json().catch(() => ({}));
                    if (!resp.ok || data.ok === false) {
                        if (resp.status === 404) {
                            throw new Error('Job watermark hilang (mungkin server restart). Silakan ulangi edit.');
                        }
                        throw new Error(data.error || 'Gagal cek status watermark.');
                    }

                    if (!data.status) {
                        throw new Error('Respons status watermark tidak valid. Refresh halaman lalu coba lagi.');
                    }

                    const status = String(data.status || '').toLowerCase();
                    if (status === 'done') return data;
                    if (status === 'failed') {
                        throw new Error(data.error || 'Proses watermark gagal.');
                    }
                }

                throw new Error('Proses watermark terlalu lama. Cek galeri lagi beberapa saat.');
            }

            async function applyWatermarkEdit() {
                const videoId = Number(editVideoId.value || 0);
                const watermarkText = String(editWatermarkText.value || '').trim();
                const outputTitle = String(editOutputTitle.value || '').trim();
                const position = String(editWatermarkPosition.value || 'bottom-right');
                const fontSize = Number(editWatermarkSize.value || 30);
                const opacity = Number(editWatermarkOpacity.value || 0.85);

                if (!videoId) {
                    await showAlert('error', 'Video tidak valid', 'Pilih video yang mau diedit dulu.');
                    return;
                }
                if (!watermarkText) {
                    await showAlert('warning', 'Watermark kosong', 'Isi teks watermark terlebih dahulu.');
                    return;
                }

                const oldBtnText = editApplyBtn.innerHTML;
                editApplyBtn.disabled = true;
                editApplyBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Memproses...';

                try {
                    const resp = await fetch('/api/video/' + videoId + '/watermark', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            watermarkText,
                            outputTitle,
                            position,
                            fontSize,
                            opacity
                        })
                    });
                    const data = await resp.json().catch(() => ({}));
                    if (!resp.ok || data.ok === false) {
                        throw new Error(data.error || 'Gagal membuat video watermark.');
                    }

                    if (data.jobId) {
                        await waitWatermarkJob(data.jobId);
                    }

                    await showAlert('success', 'Berhasil', 'Video baru dengan watermark sudah dibuat.');
                    closeEditModal();
                    window.location.reload();
                } catch (err) {
                    await showAlert('error', 'Proses gagal', err.message || 'Terjadi kesalahan saat edit video.');
                } finally {
                    editApplyBtn.disabled = false;
                    editApplyBtn.innerHTML = oldBtnText;
                }
            }

            async function deleteVideo(id) {
                const result = await askConfirm('Hapus video?', 'Video yang dihapus tidak bisa dikembalikan.');
                if (result.isConfirmed) {
                    const resp = await fetch('/api/video/' + id, { method: 'DELETE' });
                    const data = await resp.json().catch(() => ({}));
                    if (!resp.ok || data.ok === false) {
                        await showAlert('error', 'Gagal hapus', data.message || data.error || 'Tidak bisa menghapus video.');
                        return;
                    }
                    window.location.reload();
                }
            }

            document.getElementById('videoModal')?.addEventListener('click', (event) => {
                if (event.target.id === 'videoModal') closeVideoModal();
            });
            editModal?.addEventListener('click', (event) => {
                if (event.target.id === 'editModal') closeEditModal();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Escape') return;
                closeVideoModal();
                closeEditModal();
            });
        </script>

</body>

</html>
